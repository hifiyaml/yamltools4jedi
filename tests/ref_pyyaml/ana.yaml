_member:
  date: '@analysisDate@'
  state variables: &id001 [water_vapor_mixing_ratio_wrt_moist_air, air_pressure_at_surface,
    air_temperature, northward_wind, eastward_wind]
  stream name: ensemble
test:
  reference filename: testoutput/rrfs-mpasjedi-ens3dvar.ref
  test output filename: ./rrfs-mpasjedi-ens3dvar.out
  float relative tolerance: 0.02
  float absolute tolerance: 1.0e-06
  integer tolerance: 3
output:
  filename: ana.nc
  stream name: analysis
variational:
  minimizer:
    algorithm: DRPCG
  iterations:
  - geometry:
      nml_file: ./namelist.atmosphere
      streams_file: ./streams.atmosphere
      deallocate non-da fields: true
      interpolation type: unstructured
    gradient norm reduction: 1e-3
    ninner: 50
  - geometry:
      nml_file: ./namelist.atmosphere
      streams_file: ./streams.atmosphere
      deallocate non-da fields: true
      interpolation type: unstructured
    gradient norm reduction: 1e-3
    ninner: 50
cost function:
  cost type: 3D-Var
  time window:
    begin: '@beginDate@'
    length: PT4H
  jb evaluation: false
  geometry:
    nml_file: ./namelist.atmosphere
    streams_file: ./streams.atmosphere
    deallocate non-da fields: true
    interpolation type: unstructured
  analysis variables: *id001
  background:
    state variables: [water_vapor_mixing_ratio_wrt_moist_air, air_pressure_at_surface,
      air_temperature, northward_wind, eastward_wind, air_potential_temperature, dry_air_density,
      u, water_vapor_mixing_ratio_wrt_dry_air, air_pressure, landmask, seaice_fraction,
      snowc, skin_temperature_at_surface, ivgtyp, isltyp, snowh, vegetation_area_fraction,
      air_temperature_at_2m, eastward_wind_at_10m, northward_wind_at_10m, lai, smois,
      tslb, pressure_p, cloud_liquid_water, cloud_liquid_ice, graupel, rain_water,
      snow_water, cldfrac]
    filename: mpasout.nc
    date: '@analysisDate@'
  background error:
    covariance model: hybrid
    components:
    - covariance:
        covariance model: ensemble
        localization:
          localization method: SABER
          saber central block:
            saber block name: BUMP_NICAS
            active variables: *id001
            read:
              io:
                data directory: data/bumploc
                files prefix: bumploc
              drivers:
                multivariate strategy: duplicated
                read local nicas: true
              model:
                level for 2d variables: last
        members from template:
          template:
            date: '@analysisDate@'
            state variables: *id001
            stream name: ensemble
            filename: ./data/ens/mem%iMember%.nc
          pattern: '%iMember%'
          start: 1
          zero padding: 3
          nmembers: 30
      weight:
        value: '@HYB_WGT_ENS@'
  observations:
    observers:
    - obs space:
        name: adpsfc_t181
        distribution:
          name: RoundRobin
          halo size: 300e3
        obsdatain:
          engine:
            type: H5File
            obsfile: data/obs/ioda_adpsfc.nc
            missing file action: warn
          obsgrouping:
            group variables: [stationIdentification]
            sort variable: pressure
            sort order: descending
        obsdataout:
          engine:
            type: H5File
            obsfile: jdiag_adpsfc_t181.nc
            allow overwrite: true
        io pool:
          max pool size: 1
        observed variables: [airTemperature]
        simulated variables: [airTemperature]
      obs operator:
        name: VertInterp
        vertical coordinate: air_pressure
        observation vertical coordinate: pressure
        observation vertical coordinate group: MetaData
        interpolation method: log-linear
        variables:
        - name: airTemperature
      linear obs operator:
        name: VertInterp
      obs error:
        covariance model: diagonal
      obs localizations:
      - localization method: Horizontal Gaspari-Cohn
        lengthscale: 300e3
      obs filters:
      - filter: RejectList
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        where:
        - variable: QualityMarker/airTemperature
          is_in: 4-15
          value: is_not_valid
        where operator: or
        action:
          name: reduce obs space
      - filter: Domain Check
        apply at iterations: 0,1
        where:
        - variable:
            name: MetaData/timeOffset
          minvalue: -900
          maxvalue: 900
        action:
          name: reduce obs space
      - filter: Bounds Check
        filter variables:
        - name: airTemperature
        test variables:
        - name: GeoVaLs/observable_domain_mask
        minvalue: 0.0
        maxvalue: 0.5
      - filter: Perform Action
        filter variables:
        - name: airTemperature
        where:
        - variable: ObsType/airTemperature
          is_in: 181
        action:
          name: assign error
          error function:
            name: ObsFunction/ObsErrorModelStepwiseLinear
            options:
              xvar:
                name: MetaData/pressure
              xvals: [110000, 105000, 100000, 95000, 90000, 85000, 80000, 75000, 70000,
                65000, 60000, 55000, 50000, 45000, 40000, 35000, 30000, 25000, 20000,
                15000, 10000, 7500, 5000, 4000, 3000, 2000, 1000, 500, 400, 300, 200,
                100, 0]
              errors: [0.7528, 0.7528, 0.7528, 0.7528, 0.7528, 0.7528, 0.7528, 0.7528,
                0.7528, 0.7528, 0.7528, 0.7528, 0.7528, 0.7528, 0.7528, 0.7528, 0.7528,
                0.7528, 0.7528, 0.7528, 0.7528, 0.7528, 0.7528, 0.7528, 0.7528, 0.7528,
                0.7528, 0.7528, 0.7528, 0.7528, 0.7528, 0.7528, 0.7528]
      - filter: Perform Action
        filter variables:
        - name: airTemperature
        action:
          name: inflate error
          inflation factor: 1.2
        where:
        - variable: QualityMarker/airTemperature
          is_in: 3
      - filter: Perform Action
        filter variables:
        - name: airTemperature
        action:
          name: inflate error
          inflation factor: 1.2
        where:
        - variable: MetaData/pressure
          maxvalue: 10000.0
      - filter: Bounds Check
        filter variables:
        - name: airTemperature
        test variables:
        - name: ObsErrorData/airTemperature
        minvalue: 0.0
        action:
          name: reduce obs space
      - filter: Bounds Check
        filter variables:
        - name: airTemperature
        minvalue: 100
        maxvalue: 400
        action:
          name: reduce obs space
      - filter: Variable Assignment
        apply at iterations: 0,1
        assignments:
        - name: TempObsErrorData/airTemperature
          type: float
          function:
            name: ObsFunction/Arithmetic
            options:
              variables:
              - name: ObsErrorData/airTemperature
        defer to post: true
      - filter: Perform Action
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        action:
          name: assign error
          error parameter: 1.0
        where:
        - variable:
            name: ObsErrorData/airTemperature
          maxvalue: 1.0
        - variable:
            name: ObsErrorData/airTemperature
          value: is_valid
        defer to post: true
      - filter: Perform Action
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        action:
          name: assign error
          error parameter: 3.0
        where:
        - variable:
            name: ObsErrorData/airTemperature
          minvalue: 3.0
        - variable:
            name: ObsErrorData/airTemperature
          value: is_valid
        defer to post: true
      - filter: Background Check
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        threshold: 5.0
        action:
          name: reject
        where:
        - variable: ObsType/airTemperature
        - variable: QualityMarker/airTemperature
          is_not_in: 3
        defer to post: true
      - filter: Background Check
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        threshold: 3.5
        action:
          name: reject
        where:
        - variable: ObsType/airTemperature
        - variable: QualityMarker/airTemperature
          is_in: 3
        defer to post: true
      - filter: Perform Action
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        action:
          name: assign error
          error function: TempObsErrorData/airTemperature
        where:
        - variable:
            name: TempObsErrorData/airTemperature
          value: is_valid
        defer to post: true
    - obs space:
        name: adpsfc_t183
        distribution:
          name: RoundRobin
          halo size: 300e3
        obsdatain:
          engine:
            type: H5File
            obsfile: data/obs/ioda_adpsfc.nc
            missing file action: warn
          obsgrouping:
            group variables: [stationIdentification]
            sort variable: pressure
            sort order: descending
        obsdataout:
          engine:
            type: H5File
            obsfile: jdiag_adpsfc_t183.nc
            allow overwrite: true
        io pool:
          max pool size: 1
        observed variables: [airTemperature]
        simulated variables: [airTemperature]
      obs operator:
        name: VertInterp
        vertical coordinate: air_pressure
        observation vertical coordinate: pressure
        observation vertical coordinate group: MetaData
        interpolation method: log-linear
        variables:
        - name: airTemperature
      linear obs operator:
        name: VertInterp
      obs error:
        covariance model: diagonal
      obs localizations:
      - localization method: Horizontal Gaspari-Cohn
        lengthscale: 300e3
      obs filters:
      - filter: Perform Action
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        where:
        - variable: QualityMarker/airTemperature
          is_in: 4-15
          value: is_not_valid
        where operator: or
        action:
          name: reduce obs space
      - filter: Domain Check
        apply at iterations: 0,1
        where:
        - variable:
            name: MetaData/timeOffset
          minvalue: -900
          maxvalue: 900
        action:
          name: reduce obs space
      - filter: Bounds Check
        filter variables:
        - name: airTemperature
        test variables:
        - name: GeoVaLs/observable_domain_mask
        minvalue: 0.0
        maxvalue: 0.5
      - filter: Perform Action
        filter variables:
        - name: airTemperature
        where:
        - variable: ObsType/airTemperature
          is_in: 183
        action:
          name: assign error
          error function:
            name: ObsFunction/ObsErrorModelStepwiseLinear
            options:
              xvar:
                name: MetaData/pressure
              xvals: [110000, 105000, 100000, 95000, 90000, 85000, 80000, 75000, 70000,
                65000, 60000, 55000, 50000, 45000, 40000, 35000, 30000, 25000, 20000,
                15000, 10000, 7500, 5000, 4000, 3000, 2000, 1000, 500, 400, 300, 200,
                100, 0]
              errors: [2.6349, 2.6349, 2.6349, 2.6349, 2.6349, 2.6349, 2.6349, 2.6349,
                2.6349, 2.6349, 2.6349, 2.6349, 2.6349, 2.6349, 2.6349, 2.6349, 2.6349,
                2.6349, 2.6349, 2.6349, 2.6349, 2.6349, 2.6349, 2.6349, 2.6349, 2.6349,
                2.6349, 2.6349, 2.6349, 2.6349, 2.6349, 2.6349, 2.6349]
      - filter: Perform Action
        filter variables:
        - name: airTemperature
        where:
        - variable: ObsType/airTemperature
          is_in: 183
        action:
          name: inflate error
          inflation variable:
            name: ObsFunction/ObsErrorFactorPressureCheck
            options:
              variable: airTemperature
              inflation factor: 8.0
      - filter: Perform Action
        filter variables:
        - name: airTemperature
        action:
          name: inflate error
          inflation factor: 1.2
        where:
        - variable: QualityMarker/airTemperature
          is_in: 3
      - filter: Perform Action
        filter variables:
        - name: airTemperature
        action:
          name: inflate error
          inflation factor: 1.2
        where:
        - variable: MetaData/pressure
          maxvalue: 10000.0
      - filter: Bounds Check
        filter variables:
        - name: airTemperature
        test variables:
        - name: ObsErrorData/airTemperature
        minvalue: 0.0
        action:
          name: reduce obs space
      - filter: Bounds Check
        filter variables:
        - name: airTemperature
        minvalue: 100
        maxvalue: 400
        action:
          name: reduce obs space
      - filter: Variable Assignment
        apply at iterations: 0,1
        assignments:
        - name: TempObsErrorData/airTemperature
          type: float
          function:
            name: ObsFunction/Arithmetic
            options:
              variables:
              - name: ObsErrorData/airTemperature
        defer to post: true
      - filter: Perform Action
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        action:
          name: assign error
          error parameter: 1.0
        where:
        - variable:
            name: ObsErrorData/airTemperature
          maxvalue: 1.0
        - variable:
            name: ObsErrorData/airTemperature
          value: is_valid
        defer to post: true
      - filter: Perform Action
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        action:
          name: assign error
          error parameter: 3.0
        where:
        - variable:
            name: ObsErrorData/airTemperature
          minvalue: 3.0
        - variable:
            name: ObsErrorData/airTemperature
          value: is_valid
        defer to post: true
      - filter: Background Check
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        threshold: 5.0
        action:
          name: reject
        where:
        - variable: ObsType/airTemperature
        - variable: QualityMarker/airTemperature
          is_not_in: 3
        defer to post: true
      - filter: Background Check
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        threshold: 3.5
        action:
          name: reject
        where:
        - variable: ObsType/airTemperature
        - variable: QualityMarker/airTemperature
          is_in: 3
        defer to post: true
      - filter: Perform Action
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        action:
          name: assign error
          error function: TempObsErrorData/airTemperature
        where:
        - variable:
            name: TempObsErrorData/airTemperature
          value: is_valid
        defer to post: true
    - obs space:
        name: adpsfc_t187
        distribution:
          name: RoundRobin
          halo size: 300e3
        obsdatain:
          engine:
            type: H5File
            obsfile: data/obs/ioda_adpsfc.nc
            missing file action: warn
          obsgrouping:
            group variables: [stationIdentification]
            sort variable: pressure
            sort order: descending
        obsdataout:
          engine:
            type: H5File
            obsfile: jdiag_adpsfc_t187.nc
            allow overwrite: true
        io pool:
          max pool size: 1
        observed variables: [airTemperature]
        simulated variables: [airTemperature]
      obs operator:
        name: VertInterp
        vertical coordinate: air_pressure
        observation vertical coordinate: pressure
        observation vertical coordinate group: MetaData
        interpolation method: log-linear
        variables:
        - name: airTemperature
      linear obs operator:
        name: VertInterp
      obs error:
        covariance model: diagonal
      obs localizations:
      - localization method: Horizontal Gaspari-Cohn
        lengthscale: 300e3
      obs filters:
      - filter: RejectList
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        where:
        - variable: QualityMarker/airTemperature
          is_in: 4-15
          value: is_not_valid
        where operator: or
        action:
          name: reduce obs space
      - filter: Domain Check
        apply at iterations: 0,1
        where:
        - variable:
            name: MetaData/timeOffset
          minvalue: -900
          maxvalue: 900
        action:
          name: reduce obs space
      - filter: Bounds Check
        filter variables:
        - name: airTemperature
        test variables:
        - name: GeoVaLs/observable_domain_mask
        minvalue: 0.0
        maxvalue: 0.5
      - filter: Perform Action
        filter variables:
        - name: airTemperature
        where:
        - variable: ObsType/airTemperature
          is_in: 187
        action:
          name: assign error
          error function:
            name: ObsFunction/ObsErrorModelStepwiseLinear
            options:
              xvar:
                name: MetaData/pressure
              xvals: [110000, 105000, 100000, 95000, 90000, 85000, 80000, 75000, 70000,
                65000, 60000, 55000, 50000, 45000, 40000, 35000, 30000, 25000, 20000,
                15000, 10000, 7500, 5000, 4000, 3000, 2000, 1000, 500, 400, 300, 200,
                100, 0]
              errors: [2.2585, 2.2585, 2.2585, 2.2585, 2.2585, 2.2585, 2.2585, 2.2585,
                2.2585, 2.2585, 2.2585, 2.2585, 2.2585, 2.2585, 2.2585, 2.2585, 2.2585,
                2.2585, 2.2585, 2.2585, 2.2585, 2.2585, 2.2585, 2.2585, 2.2585, 2.2585,
                2.2585, 2.2585, 2.2585, 2.2585, 2.2585, 2.2585, 2.2585]
      - filter: Perform Action
        filter variables:
        - name: airTemperature
        where:
        - variable: ObsType/airTemperature
          is_in: 187
        action:
          name: inflate error
          inflation variable:
            name: ObsFunction/ObsErrorFactorPressureCheck
            options:
              variable: airTemperature
              inflation factor: 8.0
              surface observation error ramp: true
      - filter: Perform Action
        filter variables:
        - name: airTemperature
        action:
          name: inflate error
          inflation factor: 1.2
        where:
        - variable: QualityMarker/airTemperature
          is_in: 3
      - filter: Perform Action
        filter variables:
        - name: airTemperature
        action:
          name: inflate error
          inflation factor: 1.2
        where:
        - variable: MetaData/pressure
          maxvalue: 10000.0
      - filter: Bounds Check
        filter variables:
        - name: airTemperature
        test variables:
        - name: ObsErrorData/airTemperature
        minvalue: 0.0
        action:
          name: reduce obs space
      - filter: Bounds Check
        filter variables:
        - name: airTemperature
        minvalue: 100
        maxvalue: 400
        action:
          name: reduce obs space
      - filter: Variable Assignment
        apply at iterations: 0,1
        assignments:
        - name: TempObsErrorData/airTemperature
          type: float
          function:
            name: ObsFunction/Arithmetic
            options:
              variables:
              - name: ObsErrorData/airTemperature
        defer to post: true
      - filter: Perform Action
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        action:
          name: assign error
          error parameter: 1.0
        where:
        - variable:
            name: ObsErrorData/airTemperature
          maxvalue: 1.0
        - variable:
            name: ObsErrorData/airTemperature
          value: is_valid
        defer to post: true
      - filter: Perform Action
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        action:
          name: assign error
          error parameter: 3.0
        where:
        - variable:
            name: ObsErrorData/airTemperature
          minvalue: 3.0
        - variable:
            name: ObsErrorData/airTemperature
          value: is_valid
        defer to post: true
      - filter: Background Check
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        threshold: 5.0
        action:
          name: reject
        where:
        - variable: ObsType/airTemperature
        - variable: QualityMarker/airTemperature
          is_not_in: 3
        defer to post: true
      - filter: Background Check
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        threshold: 3.5
        action:
          name: reject
        where:
        - variable: ObsType/airTemperature
        - variable: QualityMarker/airTemperature
          is_in: 3
        defer to post: true
      - filter: Perform Action
        apply at iterations: 0,1
        filter variables:
        - name: airTemperature
        action:
          name: assign error
          error function: TempObsErrorData/airTemperature
        where:
        - variable:
            name: TempObsErrorData/airTemperature
          value: is_valid
        defer to post: true
